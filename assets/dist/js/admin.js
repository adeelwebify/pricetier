function p(t){const n=t.find('input[type=radio][name*="[products][type]"]:checked').val();t.find(".pricetier-condition").hide(),!(!n||n==="all")&&(t.find(".pricetier-condition-"+n).show(),n==="attribute"&&t.find(".pricetier-condition-attribute-terms").show())}function f(t){const n=t.find('input[name*="[pricing][type]"]:checked').val();t.find(".pricetier-label-percent").hide(),t.find(".pricetier-label-fixed").hide(),n==="percent"&&t.find(".pricetier-label-percent").show(),n==="fixed"&&t.find(".pricetier-label-fixed").show()}function m(t,n,i){t.hasClass("enhanced")||t.addClass("enhanced").selectWoo({ajax:{url:n,dataType:"json",delay:250,data:function(e){return{action:"pricetier_search_users",search:e.term||"",nonce:i}},processResults:function(e){return{results:e.success?e.data:[]}}},placeholder:"Search usersâ€¦",minimumInputLength:1,width:"100%"})}function d(t,n,i){const e=t.find('input[name*="[users][type]"]:checked').val();if(t.find(".pricetier-user-condition").hide(),!e||e==="all")return;const o=t.find(".pricetier-user-condition-"+e);if(o.show(),e==="users"){const c=o.find(".pricetier-user-select");requestAnimationFrame(()=>{m(c,n,i)})}}function g(t,n){function i(e){p(e),d(e,t,n),f(e),e.find("input[type=radio]").off("change.pricetier").on("change.pricetier",function(){p(e),d(e,t,n),f(e)}),e.find('input[name*="[users][type]"]').off("change.pricetier_user").on("change.pricetier_user",function(){d(e,t,n)})}$(".pricetier-rule").each(function(){i($(this))}),window.PriceTierInitSingleRule=i}function h(t,n){$(".wc-product-search").filter(":not(.enhanced)").each(function(){$(this).addClass("enhanced").select2()}),$(".wc-enhanced-select").not('select[name*="[users][users]"]').select2(),$('select[name*="[products][attribute][taxonomy]"]').off("change.pricetier").on("change.pricetier",function(){const i=$(this),e=i.val(),c=i.closest(".pricetier-rule").find('select[name*="[products][attribute][terms]"]');c.empty(),e&&$.ajax({url:t,type:"POST",dataType:"json",data:{action:"pricetier_get_attribute_terms",taxonomy:e,nonce:n},success:function(r){r.success&&(r.data.forEach(function(s){const a=new Option(s.text,s.id,!1,!1);c.append(a)}),c.trigger("change"))}})})}function y(t,n){const i=$("#pricetier-lookup-input"),e=$("#pricetier-lookup-result");i.length&&i.on("change",function(){const o=$(this).val();if(!o){e.slideUp();return}e.css("opacity",.5),$.ajax({url:t,type:"POST",dataType:"json",data:{action:"pricetier_lookup_product",product_id:o,nonce:n},success:function(c){if(e.css("opacity",1),!c.success){alert(c.data.message||"Error loading product");return}const r=c.data;$("#pt-result-key").text(r.cost_key),$("#pt-result-cost").html(r.cost),$("#pt-result-regular").html(r.regular),$("#pt-result-sale").html(r.sale),e.slideDown()},error:function(){e.css("opacity",1),alert("Request failed")}})})}jQuery(function(t){const n=window.PriceTierAdmin||{},{ajaxUrl:i,nonce:e,ruleTemplate:o}=n;if(!i)return;g(i,e),h(i,e),y(i,e);const c=document.getElementById("pricetier-rules"),r=document.getElementById("pricetier-add-rule");c&&r&&r.addEventListener("click",()=>{const s="rule_"+Date.now(),a=o.replace(/__INDEX__/g,s),u=document.createElement("template");u.innerHTML=a.trim();const l=u.content.firstElementChild;c.appendChild(l),t(document.body).trigger("wc-enhanced-select-init"),window.PriceTierInitSingleRule&&window.PriceTierInitSingleRule(t(l)),h(i,e)}),document.addEventListener("click",function(s){if(!s.target.classList.contains("pricetier-delete-rule"))return;const a=s.target.closest(".pricetier-rule");a&&confirm("Delete this rule? This cannot be undone.")&&a.remove()})});
