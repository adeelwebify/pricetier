function p(e){const c=e.find('input[type=radio][name*="[products][type]"]:checked').val();e.find(".pricetier-condition").hide(),!(!c||c==="all")&&(e.find(".pricetier-condition-"+c).show(),c==="attribute"&&e.find(".pricetier-condition-attribute-terms").show())}function f(e){const c=e.find('input[name*="[pricing][type]"]:checked').val();e.find(".pricetier-label-percent").hide(),e.find(".pricetier-label-fixed").hide(),c==="percent"&&e.find(".pricetier-label-percent").show(),c==="fixed"&&e.find(".pricetier-label-fixed").show()}function m(e,c,t){e.hasClass("enhanced")||e.addClass("enhanced").selectWoo({ajax:{url:c,dataType:"json",delay:250,data:function(n){return{action:"pricetier_search_users",search:n.term||"",nonce:t}},processResults:function(n){return{results:n.success?n.data:[]}}},placeholder:"Search usersâ€¦",minimumInputLength:1,width:"100%"})}function u(e,c,t){const n=e.find('input[name*="[users][type]"]:checked').val();if(e.find(".pricetier-user-condition").hide(),!n||n==="all")return;const i=e.find(".pricetier-user-condition-"+n);if(i.show(),n==="users"){const s=i.find(".pricetier-user-select");requestAnimationFrame(()=>{m(s,c,t)})}}function y(e,c){const t=window.jQuery;function n(i){p(i),u(i,e,c),f(i),i.find("input[type=radio]").off("change.pricetier").on("change.pricetier",function(){p(i),u(i,e,c),f(i)}),i.find('input[name*="[users][type]"]').off("change.pricetier_user").on("change.pricetier_user",function(){u(i,e,c)})}t(".pricetier-rule").each(function(){n(t(this))}),window.PriceTierInitSingleRule=n}function h(e,c){const t=window.jQuery;t(".wc-product-search").filter(":not(.enhanced)").each(function(){t(this).addClass("enhanced").select2()}),t(".wc-enhanced-select").not('select[name*="[users][users]"]').select2(),t('select[name*="[products][attribute][taxonomy]"]').off("change.pricetier").on("change.pricetier",function(){const n=t(this),i=n.val(),o=n.closest(".pricetier-rule").find('select[name*="[products][attribute][terms]"]');o.empty(),i&&t.ajax({url:e,type:"POST",dataType:"json",data:{action:"pricetier_get_attribute_terms",taxonomy:i,nonce:c},success:function(r){r.success&&(r.data.forEach(function(a){const d=new Option(a.text,a.id,!1,!1);o.append(d)}),o.trigger("change"))}})})}function g(e,c){const t=window.jQuery,n=t("#pricetier-lookup-input"),i=t("#pricetier-lookup-result");n.length&&n.on("change",function(){const s=t(this).val();if(!s){i.slideUp();return}i.css("opacity",.5),t.ajax({url:e,type:"POST",dataType:"json",data:{action:"pricetier_lookup_product",product_id:s,nonce:c},success:function(o){if(i.css("opacity",1),!o.success){alert(o.data.message||"Error loading product");return}const r=o.data;t("#pt-result-key").text(r.cost_key),t("#pt-result-cost").html(r.cost),t("#pt-result-regular").html(r.regular),t("#pt-result-sale").html(r.sale),i.slideDown()},error:function(){i.css("opacity",1),alert("Request failed")}})})}jQuery(function(e){const c=window.PriceTierAdmin||{},{ajaxUrl:t,nonce:n,ruleTemplate:i}=c;if(!t)return;y(t,n),h(t,n),g(t,n);const s=document.getElementById("pricetier-rules"),o=document.getElementById("pricetier-add-rule");s&&o&&o.addEventListener("click",()=>{const r="rule_"+Date.now(),a=i.replace(/__INDEX__/g,r),d=document.createElement("template");d.innerHTML=a.trim();const l=d.content.firstElementChild;s.appendChild(l),e(document.body).trigger("wc-enhanced-select-init"),window.PriceTierInitSingleRule&&window.PriceTierInitSingleRule(e(l)),h(t,n)}),document.addEventListener("click",function(r){if(!r.target.classList.contains("pricetier-delete-rule"))return;const a=r.target.closest(".pricetier-rule");a&&confirm("Delete this rule? This cannot be undone.")&&a.remove()})});
